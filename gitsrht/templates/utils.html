{% macro breadcrumb(ref, repo, path, path_join) %}
{% if ref != repo.git_repo.default_branch_name() %}
<span style="margin-right: 1rem">
  <span class="text-muted">ref:</span> {{ ref }}
</span>
{% endif %}
{% if path != [''] %}
<a href="{{url_for("repo.tree",
  owner=repo.owner.canonical_name, repo=repo.name, ref=ref)}}"
>{{repo.name}}</a>{% endif %}/{% for part in path%}{%
  if loop.last %}{{part}}{% else %}<a
    href="{{url_for("repo.tree", owner=repo.owner.canonical_name,
      repo=repo.name, ref=ref,
      path=path_join(*path[:loop.index]))}}"
  >{{part}}</a>/{%
endif %}{% endfor %}
{% endmacro %}

{% macro commit_event(repo, c,
  full_body=False, refs={}, full_id=False, diff=None, href=None,
  parents=False, skip_body=False, target_blank=False) %}
<div>
  {% if full_id %}
  {{c.id.hex}}
  {% else %}
  <a
    {% if href %}
    href="{{href}}"
    {% else %}
    href="{{url_for("repo.commit", owner=repo.owner.canonical_name,
      repo=repo.name, ref=c.id.hex)}}"
    {% endif %}
    title="{{c.id.hex}}"
    {% if target_blank %}
    target="_blank"
    {% endif %}
  >{{c.id.hex[:8]}}</a>
  {% endif %}
  &mdash;
  {% set author_user = lookup_user(c.author.email) %}
  {% if author_user %}
  <a href="{{url_for("public.user_index",
    username=author_user.username)}}">{{c.author.name}}</a>
  {% else %}
  {{c.author.name}}
  {% endif %}
  <small class="pull-right">
    <a
      id="log-{{c.id}}"
      href="#log-{{c.id}}"
    >{{ commit_time(c) | date }}</a>
  </small>

  {% if parents and any(c.parents) %}
  <span style="margin-left: 0.5rem">
    {{icon('code-branch', cls="sm")}}
    {% for parent in c.parents %}
    <a href="{{url_for("repo.commit",
      owner=repo.owner.canonical_name,
      repo=repo.name,
      ref=parent.id.hex)}}"
    >{{parent.short_id}}</a>
    {% if not loop.last %}
    +
    {% endif %}
    {% endfor %}
  </span>
  {% endif %}

  {% if c.id.hex in refs %}
  <span style="margin-left: 0.5rem">
    {% for ref in refs[c.id.hex] %}
    <a
      class="ref {{ref.type}}
        {{"annotated" if ref.type == "tag" and ref.tag.message else ""}}"
      {% if ref.type == "branch" %}
      href="{{url_for("repo.tree",
        owner=repo.owner.canonical_name, repo=repo.name, ref=ref.name)}}"
      {% elif ref.type == "tag" %}
      href="{{url_for("repo.ref",
          owner=repo.owner.canonical_name,
          repo=repo.name,
          ref=ref.name)}}"
      {% endif %}
    >{{ref.name}}</a>
  </span>
  {% endfor %}
  {% endif %}
</div>
{% if not skip_body %}
{% if full_body %}
<pre>{{c.message}}
{%- if diff %}
{{diffstat(diff, anchor=c.oid.hex + "-")}}{% endif -%}
</pre>
{% else %}
<pre>{{ trim_commit(c.message) }}</pre>
{% endif %}
{% endif %}
{% endmacro %}

{% macro commit_diff(repo, commit, diff, anchor="", target_blank=False) %}
{# God, working with <pre> tags is such a fucking mess #}
{% for patch in diff %}
<pre style="margin-bottom: 0;"
>{#
  #}{{patch.delta.status_char()}} {% if parent %}<a
   href="{{url_for("repo.tree",
      owner=repo.owner.canonical_name,
      repo=repo.name,
      ref=parent.id.hex,
      path=patch.delta.old_file.path)}}"
   id="{{anchor}}{{patch.delta.old_file.path}}"
  {% if target_blank %}
  target="_blank"
  {% endif %}
 >{{patch.delta.old_file.path}}</a>{#
 #}{% endif %} =&gt; {#
 #}<a
   href="{{url_for("repo.tree",
      owner=repo.owner.canonical_name,
      repo=repo.name,
      ref=commit.id.hex,
      path=patch.delta.new_file.path)}}"
   id="{{anchor}}{{patch.delta.new_file.path}}"
  {% if target_blank %}
  target="_blank"
  {% endif %}
 >{{patch.delta.new_file.path}}</a>{#
 #} <span class="pull-right"><span class="text-success">+{{patch.line_stats[1]}}</span>{#
 #} <span class="text-danger">-{{patch.line_stats[2]}}</span></span>{%
    if patch.delta.old_file.mode != patch.delta.new_file.mode %}{#
  #}{#
  #}{% endif %}</pre>
<div class="event diff">
  <pre>{% for hunk in patch.hunks %}
{% set hunk_index = loop.index %}<strong
  class="text-info"
>@@ {#
#}{% if parent %}<a
  style="text-decoration: underline"
  href="{{url_for("repo.tree",
    owner=repo.owner.canonical_name,
    repo=repo.name,
    ref=parent.id.hex,
    path=patch.delta.old_file.path)}}#L{{hunk.old_start}}"
  {% if target_blank %}
  target="_blank"
  {% endif %}
>{{hunk.old_start}}</a>,{{hunk.old_lines}} {#
#}{% endif %}<a
  style="text-decoration: underline"
  href="{{url_for("repo.tree",
    owner=repo.owner.canonical_name,
    repo=repo.name,
    ref=commit.id.hex,
    path=patch.delta.new_file.path)}}#L{{hunk.new_start}}"
  {% if target_blank %}
  target="_blank"
  {% endif %}
>{{hunk.new_start}}</a>,{{hunk.new_lines}} {#
#}@@{{hunk.header.split('@@')[-1][:-1]}}</strong>
{% for line in hunk.lines
%}<span class="{{({
  "+":"text-success",
  "-":"text-danger",
  }).get(line.origin) or ""}}"><a
    href="#{{anchor}}{{patch.delta.old_file.path}}-{{hunk_index}}-{{loop.index}}"
    id="{{anchor}}{{patch.delta.old_file.path}}-{{hunk_index}}-{{loop.index}}"
    aria-hidden="true"
    class="lineno"
    style="color: inherit"
>{{line.origin}}</a>{{line.content}}{#
#}</span>{% endfor %}
{% endfor %}</pre>
</div>
{% endfor %}
{% endmacro %}
